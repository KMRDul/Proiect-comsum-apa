{% extends 'layout.html' %}

{% block content %}
<div class="action-buttons">
    <button id="addPersonBtn" class="action-button">{{ 'Adaugă Locatar' if language == 'ro' else 'Add Tenant' }}</button>
    <button id="toggleDeleteBtn" class="action-button">{{ 'Elimină Locatar' if language == 'ro' else 'Remove Tenant' }}</button>
    <a href="{{ url_for('reset_water_data') }}" class="action-button" onclick="return confirm('{{ 'Ești sigur că vrei să resetezi toate datele de consum și plăți?' if language == 'ro' else 'Are you sure you want to reset all consumption data and payments?' }}')">
        {{ 'Resetează Consumul și Plățile' if language == 'ro' else 'Reset Consumption & Payments' }}
    </a>
    <button id="toggleDrawer" class="drawer-toggle">
        {{ 'Blocuri' if language == 'ro' else 'Buildings' }}
    </button>
</div>

<div id="drawer" class="drawer">
    <div class="drawer-content">
        <div class="drawer-header">
            <h3>{{ 'Blocuri' if language == 'ro' else 'Buildings' }}</h3>
            <div class="drawer-actions">
                <button id="addBuilding" class="building-action" title="{{ 'Adaugă Bloc' if language == 'ro' else 'Add Building' }}">+</button>
                <button id="removeBuilding" class="building-action" title="{{ 'Elimină Bloc' if language == 'ro' else 'Remove Building' }}">-</button>
            </div>
        </div>
        <div id="buildingsList">
            <!-- Lista blocurilor va fi populată dinamic -->
        </div>
    </div>
</div>

<div id="addPersonForm" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>{{ 'Adaugă Locatar' if language == 'ro' else 'Add Tenant' }}</h2>
        <form method="POST" action="{{ url_for('add_user_route') }}" style="display: flex; flex-direction: column; gap: 15px;">
            <input type="text" name="name" placeholder="{{ 'Nume' if language == 'ro' else 'Name' }}" required>
            <input type="text" name="apartment" placeholder="{{ 'Apartament' if language == 'ro' else 'Apartment' }}" required>
            <button type="submit" class="submit-button">{{ 'Adaugă' if language == 'ro' else 'Add' }}</button>
        </form>
    </div>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
            <div class="flash-message">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="table-container">
    <style>
    .drawer-toggle {
        position: fixed;
        left: 20px;
        top: 20px;
        padding: 10px 20px;
        background-color: white;
        color: #666;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        z-index: 1000;
        transition: background-color 0.3s;
    }

    .drawer-toggle:hover {
        background-color: #f5f5f5;
    }

    .drawer {
        position: fixed;
        left: -300px;
        top: 0;
        width: 300px;
        height: 100%;
        background-color: white;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        transition: left 0.3s ease;
        z-index: 999;
    }

    .drawer.open {
        left: 0;
    }

    .drawer-content {
        padding: 20px;
        padding-top: 60px;
    }

    .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .drawer-actions {
        display: flex;
        gap: 10px;
    }

    .building-action {
        width: 30px;
        height: 30px;
        border: 1px solid #ddd;
        background-color: white;
        color: #666;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: all 0.3s;
    }

    .building-action:hover {
        background-color: #f5f5f5;
        border-color: #ccc;
    }

    .building-item {
        padding: 10px;
        margin-bottom: 10px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .building-item:hover {
        background-color: #f5f5f5;
        border-color: #ccc;
        transform: translateX(5px);
    }

    .drawer h3 {
        margin-bottom: 20px;
        color: #333;
    }

    .building-item {
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .building-item:hover {
        background-color: #e9e9e9;
    }
    </style>
    <h2 style="text-align: center; margin-bottom: 15px;">{{ 'Bloc B3' if language == 'ro' else 'Building B3' }}</h2>
    <table>
        <tr>
            <th>{{ 'AP' if language == 'ro' else 'APT' }}</th>
            <th>{{ 'Nume' if language == 'ro' else 'Name' }}</th>
            <th>{{ 'Consum Apă (mc)' if language == 'ro' else 'Water Usage (m³)' }}</th>
            <th>{{ 'Cost Apă (Lei)' if language == 'ro' else 'Water Cost (Lei)' }}</th>
            <th>{{ 'Suma' if language == 'ro' else 'Amount' }}</th>
            <th>{{ 'Acțiune' if language == 'ro' else 'Action' }}</th>
        </tr>
        {% for user in users %}
        <tr>
            <td>{{ user.apartment }}</td>
            <td>
                {{ user.name }}
                <button onclick="deleteUser({{ user.id }})" class="delete-button" style="display: none;">×</button>
            </td>
            <td id="water-consumption-{{ user.id }}">{{ "%.2f"|format(water_data[user.id]|default(0)) }}</td>
            <td id="water-cost-{{ user.id }}">{{ "%.2f"|format((water_data[user.id]|default(0) * water_price - user.amount_paid)) }}</td>
            <td>
                <form method="POST" action="{{ url_for('update_payment', user_id=user.id) }}">
                    <input type="number" name="amount_paid" step="0.01" placeholder="{{ 'Suma' if language == 'ro' else 'Amount' }}" required>
                    <input type="submit" value="{{ 'Plătește' if language == 'ro' else 'Pay' }}">
                </form>
            </td>
            <td>
                {% if (water_data[user.id]|default(0) * water_price - user.amount_paid) <= 0 %}
                    <span style="color: green;">{{ 'Plătit' if language == 'ro' else 'Paid' }}</span>
                {% else %}
                    <span style="color: red;">{{ 'Neplătit' if language == 'ro' else 'Unpaid' }}</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<script>
    const language = document.documentElement.lang || 'ro';

    // Funcționalitate pentru sertar
    document.getElementById('toggleDrawer').addEventListener('click', function() {
        document.getElementById('drawer').classList.toggle('open');
    });

    // Funcționalitate pentru adăugare bloc
    document.getElementById('addBuilding').addEventListener('click', function() {
        const buildingNumber = prompt(language === 'ro' ? 'Introduceți numărul blocului:' : 'Enter building number:');
        if (buildingNumber) {
            fetch('/add_building', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ building: buildingNumber })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    updateBuildingsList();
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    // Funcționalitate pentru ștergere bloc
    document.getElementById('removeBuilding').addEventListener('click', function() {
        const buildingNumber = prompt(language === 'ro' ? 'Introduceți numărul blocului de șters:' : 'Enter building number to remove:');
        if (buildingNumber) {
            fetch('/remove_building', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ building: buildingNumber })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    updateBuildingsList();
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    // Funcție pentru actualizarea listei de blocuri
    function updateBuildingsList() {
        fetch('/get_buildings')
            .then(response => response.json())
            .then(buildings => {
                const buildingsList = document.getElementById('buildingsList');
                buildingsList.innerHTML = '';
                
                buildings.forEach(building => {
                    const div = document.createElement('div');
                    div.className = 'building-item';
                    div.textContent = `${building.name} (${building.tenants} ${language === 'ro' ? 'locatari' : 'tenants'})`;
                    div.onclick = function() {
                        const buildingNumber = building.name.split(' ')[1];
                        window.location.href = `/building/${buildingNumber}`;
                    };
                    buildingsList.appendChild(div);
                });
            })
            .catch(error => console.error('Error:', error));
    }

    // Apelează funcția la încărcarea paginii
    updateBuildingsList();

    // Funcție pentru actualizarea datelor despre apă
    function updateWaterData() {
        fetch('/update_water')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('A apărut o eroare!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('A apărut o eroare!');
            });
    }
    // Funcție pentru ștergerea unui utilizator
    function deleteUser(userId) {
        if (confirm(language === 'ro' ? 'Ești sigur că vrei să ștergi acest locatar?' : 'Are you sure you want to delete this tenant?')) {
            fetch(`/delete_user/${userId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('A apărut o eroare!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('A apărut o eroare!');
            });
        }
    }

    // Model și butoane
    const modal = document.getElementById('addPersonForm'),
          addBtn = document.getElementById('addPersonBtn'),
          closeBtn = document.getElementsByClassName('close')[0],
          toggleDeleteBtn = document.getElementById('toggleDeleteBtn'),
          deleteButtons = document.getElementsByClassName('delete-button');

    // Funcționalitate pentru modal
    addBtn.onclick = function() {
        modal.style.display = 'block';
    }

    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

toggleDeleteBtn.onclick = function() {
    const isDeleting = toggleDeleteBtn.classList.toggle('active');
    Array.from(deleteButtons).forEach(button => {
        button.style.display = isDeleting ? 'inline-block' : 'none';
    });
    toggleDeleteBtn.textContent = isDeleting ? 
        '{{ 'Anulează Ștergere' if language == 'ro' else 'Cancel Delete' }}' : 
        '{{ 'Elimină Locatar' if language == 'ro' else 'Remove Tenant' }}';
}

// {{ 'Actualizare la fiecare 30 secunde' if language == 'ro' else 'Update every 30 seconds' }}
setInterval(updateWaterData, 30000);
</script>

<style>
    .table-container {
        margin: 20px;
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #f5f5f5;
        font-weight: bold;
    }
    tr:hover {
        background-color: #f9f9f9;
    }
    input[type="number"] {
        width: 100px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    input[type="submit"] {
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    input[type="submit"]:hover {
        background-color: #45a049;
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        margin: 20px auto;
        gap: 20px;
    }

    .action-button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #4CAF50;
        color: white;
        transition: background-color 0.3s;
        margin: 0 10px;
    }

    .action-button:hover {
        background-color: #45a049;
    }

    .action-button.active {
        background-color: #ff4444;
    }

    .action-button.active:hover {
        background-color: #cc0000;
    }

    .delete-button {
        margin-left: 10px;
        padding: 2px 8px;
        background-color: #ffffff;
        color: rgb(255, 7, 7);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
        display: none;
    }

    .delete-button:hover {
        background-color: #ffffff;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #f5f5f5;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 300px;
        border-radius: 5px;
        position: relative;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: #000;
    }

    .modal input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #ffffff;
        color: #000000;
        font-size: 14px;
    }

    .submit-button {
        width: 100%;
        padding: 12px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }

    .submit-button:hover {
        background-color: #45a049;
    }

    .flash-message {
        margin: 20px;
        padding: 10px;
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
    }
</style>
{% endblock %}